<!DOCTYPE html>
<html dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Backfill Tags</title>
</head>
<body>
    <h2>תיוג רטרואקטיבי</h2>
    <button id="run">הרצי תיוג על כל המתכונים</button>
    <div id="status" style="margin-top:20px; font-family: monospace; white-space: pre-line;"></div>

    <script type="module">
        import { db } from '/firebase.js';
        import { collection, getDocs, updateDoc, doc } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";
import { suggestTags } from '/recipe-import-utils.js';

        const status = document.getElementById('status');

        document.getElementById('run').addEventListener('click', async () => {
            status.textContent = 'טוענת מתכונים...';
            const snapshot = await getDocs(collection(db, 'recipes'));
            const recipes = [];
            snapshot.forEach(d => recipes.push({ id: d.id, ...d.data() }));
            status.textContent = `נמצאו ${recipes.length} מתכונים. מתייגת...\n`;

            let done = 0, skipped = 0;
            for (const recipe of recipes) {
                if (recipe.tags && recipe.tags.length > 0) {
                    skipped++;
                    continue;
                }
                const tags = suggestTags(recipe.name || '');
                await updateDoc(doc(db, 'recipes', recipe.id), { tags });
                done++;
                status.textContent += `✅ ${recipe.name} → ${tags.join(', ') || 'ללא תגיות'}\n`;
            }
            status.textContent += `\nסיום! ${done} תויגו, ${skipped} כבר היה להם תגיות.`;
        });
    </script>
</body>
</html>