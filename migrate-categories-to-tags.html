<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×”××¨×ª ×§×˜×’×•×¨×™×•×ª ×œ×ª×’×™×•×ª</title>
    <style>
        body { font-family: 'Varela Round', sans-serif; padding: 24px; max-width: 560px; margin: 0 auto; }
        h1 { color: #407076; }
        p, li { color: #333; line-height: 1.5; }
        button { padding: 12px 20px; background: #407076; color: white; border: none; border-radius: 8px; font-size: 1rem; cursor: pointer; margin-top: 8px; }
        button:disabled { opacity: 0.6; cursor: not-allowed; }
        #log { margin-top: 16px; white-space: pre-wrap; font-size: 0.9rem; color: #698996; }
        .err { color: #c00; }
        .ok { color: #0a0; }
        .steps { background: #f0f7f8; padding: 16px; border-radius: 12px; margin: 16px 0; }
    </style>
</head>
<body>
    <h1>×”××¨×ª ×§×˜×’×•×¨×™×•×ª ×œ×ª×’×™×•×ª ×—×“×©×•×ª</h1>
    <p>×”×¡×§×¨×™×¤×˜ ×¢×•×‘×¨ ×¢×œ <strong>×›×œ</strong> ×”××ª×›×•× ×™× ×‘-Firebase, ×œ×•×§×— ××ª ×”×§×˜×’×•×¨×™×” ×”×™×©× ×” ×©×œ ×›×œ ××ª×›×•×Ÿ ×•×××™×¨ ××•×ª×” ×œ×ª×’×™×ª (××• ×ª×’×™×•×ª) ××”××¢×¨×›×ª ×”×—×“×©×”. ×”×§×˜×’×•×¨×™×” ×¢×¦××” ××ª××¤×¡×ª.</p>

    <div class="steps" style="margin-bottom: 20px;">
        <strong>ğŸ“‹ ×”×¨×©×™××” ×”×—×“×©×” ×©×œ ×”×ª×’×™×•×ª (×œ×¢×¨×™×›×” ×™×“× ×™×ª ×‘-Firebase â€“ ×”×¢×ª×™×§×™ ××›××Ÿ)</strong>
        <p style="margin: 10px 0 6px 0; font-size: 0.95rem;">×× ×•×ª ×¢×™×§×¨×™×•×ª: ×‘×©×¨, ×“×’×™×, ×¤×¡×˜×•×ª, ×˜×¨×˜×™× ×•×¤×©×˜×™×“×•×ª, ×¦××—×•× ×™</p>
        <p style="margin: 0 0 6px 0; font-size: 0.95rem;">×¡×œ×˜×™× â€¢ ×ª×•×¡×¤×•×ª â€¢ ×œ×—× ×•×××¤×™× â€¢ ×¨×•×˜×‘×™× ×•×××¨×—×™× â€¢ ××¨×§×™×</p>
        <p style="margin: 0 0 6px 0; font-size: 0.95rem;">×§×™× ×•×—×™×: ×¢×•×’×•×ª, ×¢×•×’×™×•×ª, ×§×™× ×•×—×™×, ×©×•×§×•×œ×“</p>
        <p style="margin: 0 0 0 0; font-size: 0.95rem;">××¨×•×—×•×ª ×‘×•×§×¨ â€¢ ×—×˜×™×¤×™× â€¢ ×©×ª×™×™×”</p>
    </div>

    <div class="steps">
        <strong>××™×š ×œ×”×¨×™×¥ ×”××¨×” ××•×˜×•××˜×™×ª:</strong>
        <ol style="margin: 8px 0 0 0; padding-right: 20px;">
            <li>×¤×ª×—×™ ××ª ×”××ª×¨ (××”××—×©×‘ ××• ×-Netlify).</li>
            <li>×‘×©×•×¨×ª ×”×›×ª×•×‘×ª ×”×•×¡×™×¤×™ ×‘×¡×•×£: <code>/migrate-categories-to-tags.html</code>.</li>
            <li>×”×ª×—×‘×¨×™ ×¢× Google (×× ×¢×“×™×™×Ÿ ×œ× ××—×•×‘×¨×ª).</li>
            <li>×œ×—×¦×™ ×¢×œ ×”×›×¤×ª×•×¨ ×œ××˜×”.</li>
            <li>×œ××—×¨ ×”×¡×™×•× â€“ ×¨×¢× × ×™ ××ª ×“×£ ×”××ª×›×•× ×™×.</li>
        </ol>
    </div>

    <p id="authStatus">×˜×•×¢×Ÿ ×¡×§×¨×™×¤×˜...</p>
    <button id="runBtn" disabled>×”××¨ ×§×˜×’×•×¨×™×•×ª ×œ×ª×’×™×•×ª ×‘×›×œ ×”××ª×›×•× ×™×</button>
    <button id="signInBtn" style="display:none; background:#698996; margin-right:8px;">×”×ª×—×‘×¨×™ ×¢× Google</button>
    <p id="hint" style="margin-top:12px; font-size:0.85rem; color:#698996; display:none;">×× ×›×œ×•× ×œ× ×§×•×¨×”: ×¤×ª×—×™ ××ª ×”××¡×•×£ (F12 â†’ Console) ×•×‘×“×§×™ ×× ××•×¤×™×¢×” ×©×’×™××” ×‘××“×•×.</p>
    <pre id="log"></pre>

    <script type="module">
        const authStatus = document.getElementById('authStatus');
        const hint = document.getElementById('hint');
        try {
            var firebaseModule = await import('/firebase.js');
        } catch (err) {
            authStatus.textContent = '×©×’×™××” ×‘×˜×¢×™× ×ª Firebase: ' + (err.message || err);
            hint.style.display = 'block';
            throw err;
        }
        const { db, auth, signInWithGoogle, onUserChange } = firebaseModule;
        const { collection, getDocs, doc, updateDoc } = await import('https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js');

        authStatus.textContent = '×‘×•×“×§ ×”×ª×—×‘×¨×•×ª...';

        /** ××™×¤×•×™: ×§×˜×’×•×¨×™×” ×™×©× ×” â†’ ×ª×’×™×•×ª ×—×“×©×•×ª (××”×¨×©×™××” ×”×—×“×©×”) */
        const CATEGORY_TO_TAGS = {
            '×‘×©×¨×™': ['×‘×©×¨'],
            '×“×’×™×': ['×“×’×™×'],
            '×¦××—×•× ×™': ['×¦××—×•× ×™'],
            '×¡×œ×˜×™×': ['×¡×œ×˜×™×'],
            '××¨×§×™×': ['××¨×§×™×'],
            '×§×™× ×•×—×™×': ['×§×™× ×•×—×™×'],
            '×ª×•×¡×¤×•×ª': ['×ª×•×¡×¤×•×ª'],
            '×œ×—××™×': ['×œ×—× ×•×××¤×™×'],
            '×××¤×™×': ['×œ×—× ×•×××¤×™×'],
            '×¢×•×’×•×ª': ['×¢×•×’×•×ª'],
            '×¢×•×’×™×•×ª': ['×¢×•×’×™×•×ª'],
            '×××¨×—×™×': ['×¨×•×˜×‘×™× ×•×××¨×—×™×'],
            '×¢×™×§×¨×™×•×ª': [],
            '×›×œ×œ×™': [],
            '×—×œ×‘×™': [],
            '×¤×¨×•×•×”': []
        };

        const logEl = document.getElementById('log');
        const runBtn = document.getElementById('runBtn');
        const signInBtn = document.getElementById('signInBtn');

        function log(msg, isErr = false) {
            logEl.textContent += msg + '\n';
            logEl.classList.toggle('err', isErr);
            logEl.classList.toggle('ok', !isErr && msg.includes('âœ…'));
        }

        onUserChange((user) => {
            if (user) {
                authStatus.textContent = '××—×•×‘×¨×ª: ' + (user.displayName || user.email);
                signInBtn.style.display = 'none';
                runBtn.disabled = false;
            } else {
                authStatus.textContent = '×œ× ××—×•×‘×¨×ª â€“ ×”×ª×—×‘×¨×™ ×›×“×™ ×œ×”×¨×™×¥.';
                signInBtn.style.display = 'inline-block';
                runBtn.disabled = true;
            }
        });

        signInBtn.addEventListener('click', async () => {
            await signInWithGoogle();
        });

        runBtn.addEventListener('click', async () => {
            logEl.textContent = '';
            log('××ª×—×™×œ...');
            if (!auth.currentUser) {
                log('×¦×¨×™×š ×œ×”×ª×—×‘×¨ ×§×•×“×.', true);
                return;
            }
            runBtn.disabled = true;
            log('×˜×•×¢×Ÿ ××ª×›×•× ×™× ×-Firebase...');
            try {
                const snapshot = await getDocs(collection(db, 'recipes'));
                log('× ××¦××• ' + snapshot.size + ' ××ª×›×•× ×™×. ××¢×“×›×Ÿ...');
                let updated = 0;
                let skipped = 0;
                for (const d of snapshot.docs) {
                    const data = d.data();
                    const oldCategory = (data.category || '').trim();
                    const newTags = CATEGORY_TO_TAGS[oldCategory] !== undefined
                        ? CATEGORY_TO_TAGS[oldCategory]
                        : [];

                    await updateDoc(doc(db, 'recipes', d.id), {
                        tags: newTags,
                        category: ''
                    });
                    const name = data.name || d.id;
                    if (newTags.length) {
                        log(name + ' â† ' + oldCategory + ' â†’ ' + newTags.join(', '));
                        updated++;
                    } else {
                        log(name + ' (×§×˜×’×•×¨×™×”: ' + (oldCategory || 'â€”') + ', ×‘×œ×™ ×ª×’×™×ª ×—×“×©×”)');
                        skipped++;
                    }
                }
                log('âœ… ×¡×™×•×: ' + updated + ' ××ª×›×•× ×™× ×§×™×‘×œ×• ×ª×’×™×•×ª, ' + skipped + ' ×‘×œ×™ ×ª×’×™×ª.');
            } catch (e) {
                log('×©×’×™××”: ' + (e.message || e), true);
            }
            runBtn.disabled = false;
        });
    </script>
</body>
</html>
