rules_version = '2';
// דרוש: ליצור ב-Firebase Console את המסמכים:
// config/admins  → { "uids": ["ה-UID של נועה מגוגל"] }
// config/approvedUsers → { "uids": ["אותו UID", "..." ] }
// כך שרק משתמשות מאושרות יוכלו להוסיף מתכונים, ורק אדמין יוכל לאשר משתמשות.
service cloud.firestore {
  match /databases/{database}/documents {

    // פונקציות עזר
    function isApproved() {
      return exists(/databases/$(database)/documents/config/approvedUsers)
        && request.auth.uid in get(/databases/$(database)/documents/config/approvedUsers).data.get('uids', []);
    }
    function isAdmin() {
      return exists(/databases/$(database)/documents/config/admins)
        && request.auth.uid in get(/databases/$(database)/documents/config/admins).data.get('uids', []);
    }

    // מתכונים – כולם קוראים; יצירה רק למשתמשות מאושרות; עריכה/מחיקה למוסיפה או לאדמין
    match /recipes/{recipeId} {
      allow read: if true;
      allow create: if request.auth != null && (isApproved() || !exists(/databases/$(database)/documents/config/approvedUsers));
      allow update, delete: if request.auth != null && (resource.data.addedByUid == request.auth.uid || isAdmin());

      match /likes/{userId} {
        allow read: if true;
        allow create, delete: if request.auth != null && request.auth.uid == userId;
      }

      match /comments/{commentId} {
        allow read: if true;
        allow create: if request.auth != null;
        allow update, delete: if request.auth != null && resource.data.userId == request.auth.uid;
      }
    }

    // config/admins – קריאה למחוברים; כתיבה רק ידנית ב-Console (למניעת חסימת אדמין)
    match /config/admins {
      allow read: if request.auth != null;
      allow write: if false;
    }
    // config/approvedUsers – קריאה למחוברים; כתיבה רק לאדמין
    match /config/approvedUsers {
      allow read: if request.auth != null;
      allow write: if request.auth != null && isAdmin();
    }
    // config/tags ושאר config – כמו קודם
    match /config/{docId} {
      allow read: if true;
      allow write: if request.auth != null && (docId == 'tags' || docId == 'tagGroups' || isAdmin());
    }

    // משתמשות ממתינות – כל מחובר יכול ליצור את הרשומה של עצמו; אדמין יכול לקרוא ולמחוק
    match /pendingUsers/{userId} {
      allow create: if request.auth != null && request.auth.uid == userId;
      allow read, delete: if request.auth != null && isAdmin();
      allow update: if false;
    }
  }
}
