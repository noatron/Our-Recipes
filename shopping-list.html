<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>רשימת קניות - מפה לפה</title>
    <link rel="icon" href="logo.svg" type="image/svg+xml">
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Varela+Round&display=swap" rel="stylesheet">
    <style>
        .shopping-list-page { max-width: 560px; margin: 0 auto; padding: 20px; font-family: 'Varela Round', sans-serif; }
        .shopping-list-page h1 { color: #407076; font-size: 1.8rem; font-weight: 400; margin-bottom: 8px; display: flex; align-items: center; gap: 10px; }
        .shopping-list-page .back-link { display: inline-flex; align-items: center; gap: 6px; color: #407076; text-decoration: none; margin-bottom: 24px; font-size: 1rem; }
        .shopping-list-page .back-link:hover { color: #698996; }
        .sl-empty { background: #FFF5EE; border: 2px solid #FFD8BE; border-radius: 12px; padding: 24px; text-align: center; color: #407076; margin-bottom: 20px; }
        .sl-list { list-style: none; padding: 0; margin: 0 0 24px; background: #FFEEDD; border-radius: 12px; padding: 16px; box-shadow: 0 2px 12px rgba(0,0,0,0.08); }
        .sl-list li { display: flex; align-items: center; justify-content: space-between; padding: 12px 14px; border-bottom: 1px solid #FFD8BE; color: #407076; font-size: 1.05rem; }
        .sl-list li:last-child { border-bottom: none; }
        .sl-list li.sl-category-header { font-weight: 700; color: #2d5a5f; border-bottom: 2px solid #FFD8BE; justify-content: flex-start; background: rgba(255,255,255,0.5); }
        .sl-list li.sl-category-header .sl-remove { display: none; }
        .sl-list li .sl-remove { background: transparent; border: none; color: #698996; cursor: pointer; padding: 4px 8px; font-size: 0.9rem; }
        .sl-list li .sl-remove:hover { color: #d32f2f; }
        .sl-count { color: #698996; font-size: 0.9rem; margin-right: 8px; }
        .sl-actions { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; }
        .sl-btn { padding: 12px 20px; border-radius: 10px; font-family: inherit; font-size: 1rem; cursor: pointer; border: none; display: inline-flex; align-items: center; gap: 8px; }
        .sl-btn-primary { background: #407076; color: #FFEEDD; }
        .sl-btn-primary:hover { background: #698996; }
        .sl-btn-secondary { background: #FFF5EE; color: #407076; border: 2px solid #FFD8BE; }
        .sl-btn-secondary:hover { background: #FFEEDD; }
        .sl-btn-danger { background: transparent; color: #698996; border: 2px solid #698996; }
        .sl-btn-danger:hover { background: #ffebee; color: #d32f2f; border-color: #d32f2f; }
        .sl-saved-section { margin-top: 32px; padding-top: 24px; border-top: 2px solid #FFD8BE; }
        .sl-saved-section h2 { color: #407076; font-size: 1.2rem; font-weight: 400; margin-bottom: 12px; }
        .sl-saved-list { background: white; border: 2px solid #FFD8BE; border-radius: 10px; padding: 12px 16px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
        .sl-saved-list button { padding: 6px 12px; font-size: 0.9rem; }
    </style>
</head>
<body>
    <div class="shopping-list-page">
        <a href="index.html" class="back-link">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m9 18 6-6-6-6"/></svg>
            חזרה לדף הבית
        </a>
        <h1>
            <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 0 1-8 0"/></svg>
            רשימת קניות
        </h1>
        <p style="color:#698996;margin:0 0 20px;font-size:0.95rem;">הרשימה זמנית עד שתשמרי אותה. מרכיבים מכמה מתכונים מתאחדים (למשל 2 עגבניות). מוצג רק שם המרכיב בלי פירוט הכנה (למשל שעועית ולא שעועית מושרית). תבלינים ושמן לא נכללים.</p>

        <div id="slFromCreateHint" style="display: none; background: #e8f5e9; border: 1px solid #81c784; border-radius: 10px; padding: 12px 16px; margin-bottom: 16px; color: #2e7d32; font-size: 0.95rem;">הרשימה נוצרה. אפשר לשתף בווטסאפ למטה.</div>

        <div id="slEmpty" class="sl-empty" style="display: none;">
            הרשימה ריקה. הוסיפי מרכיבים מדפי מתכונים (תפריט ⟳ → הוסיפי לרשימת קניות).
        </div>

        <div id="slContent" style="display: none;">
            <ul id="slList" class="sl-list"></ul>
            <div class="sl-actions">
                <button type="button" class="sl-btn sl-btn-primary" id="slShareWhatsApp">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                    שתפי בווטסאפ
                </button>
                <button type="button" class="sl-btn sl-btn-secondary" id="slSave">שמור רשימה</button>
                <button type="button" class="sl-btn sl-btn-danger" id="slClear">נקה רשימה</button>
            </div>
        </div>

        <div id="slSavedSection" class="sl-saved-section" style="display: none;">
            <h2>האיזור שלי</h2>
            <p id="slSavedHint" class="sl-saved-hint" style="color:#698996;font-size:0.9rem;margin:0 0 12px;"></p>
            <div id="slAuthBtnWrap" style="display: none; margin-bottom: 12px;">
                <button type="button" id="slAuthBtn" class="sl-btn sl-btn-secondary">התחברי עם Google</button>
            </div>
            <div id="slSavedLists"></div>
        </div>
    </div>

    <script src="shopping-list-state.js"></script>
    <script>
        const slEmpty = document.getElementById('slEmpty');
        const slContent = document.getElementById('slContent');
        const slList = document.getElementById('slList');
        const slSavedSection = document.getElementById('slSavedSection');
        const slSavedHint = document.getElementById('slSavedHint');
        const slSavedLists = document.getElementById('slSavedLists');

        /** מפה id → אובייקט רשימה (עינה בלחיצה) */
        var slSavedListsMap = {};
        /** כשמחוברים – רשימות מפיירבייס; אחרת null (שימוש ב-localStorage) */
        var slSavedListsOverride = null;
        var slIsLoggedIn = false;
        var slAuthBtnWrap = document.getElementById('slAuthBtnWrap');

        var fromCreate = (function () {
            var p = new URLSearchParams(window.location.search);
            if (p.get('fromCreate') === '1') {
                if (window.history.replaceState) window.history.replaceState(null, '', 'shopping-list.html');
                return true;
            }
            return false;
        })();
        if (fromCreate) {
            var hint = document.getElementById('slFromCreateHint');
            if (hint) hint.style.display = 'block';
        }

        function render() {
            const grouped = window.ShoppingList.getAggregatedGroupedByCategory();
            const order = window.ShoppingList.CATEGORY_ORDER || [];
            var totalItems = 0;
            var parts = [];
            order.forEach(function (cat) {
                var items = grouped[cat];
                if (!items || items.length === 0) return;
                totalItems += items.length;
                parts.push('<li class="sl-category-header"><span>' + escapeHtml(cat) + '</span><button type="button" class="sl-remove" aria-label="הסרי">✕</button></li>');
                items.forEach(function (item) {
                    var alreadyMerged = /^\d|^חצי\s|^רבע\s/.test(item.displayText || '');
                    var countLabel = (!alreadyMerged && item.count > 1) ? ' <span class="sl-count">x' + item.count + '</span>' : '';
                    parts.push('<li data-key="' + escapeAttr(item.key) + '">' +
                        '<span>' + escapeHtml(item.displayText) + countLabel + '</span>' +
                        '<button type="button" class="sl-remove" aria-label="הסרי">✕</button></li>');
                });
            });
            if (totalItems === 0) {
                slEmpty.style.display = 'block';
                slContent.style.display = 'none';
            } else {
                slEmpty.style.display = 'none';
                slContent.style.display = 'block';
                slList.innerHTML = parts.join('');
                slList.querySelectorAll('li[data-key] .sl-remove').forEach(function (btn) {
                    btn.addEventListener('click', function () {
                        const key = this.closest('li').dataset.key;
                        window.ShoppingList.removeByKey(key);
                        render();
                    });
                });
            }
            var saved = (slSavedListsOverride && Array.isArray(slSavedListsOverride))
                ? slSavedListsOverride
                : window.ShoppingList.getSavedLists();
            slSavedListsMap = {};
            saved.forEach(function (list) { slSavedListsMap[list.id] = list; });
            slSavedSection.style.display = 'block';
            if (slSavedHint) {
                slSavedHint.textContent = slIsLoggedIn
                    ? 'הרשימות נשמרות בחשבון שלך ונגישות מכל מכשיר.'
                    : (saved.length > 0
                        ? 'הרשימות נשמרות בדפדפן במכשיר הזה. התחברי כדי לשמור בענן ולגשת מכל מכשיר.'
                        : 'התחברי כדי לשמור רשימות בחשבון ולגשת אליהן מכל מכשיר.');
            }
            if (slAuthBtnWrap) slAuthBtnWrap.style.display = slIsLoggedIn ? 'none' : 'block';
            slSavedLists.innerHTML = saved.length === 0
                ? '<p class="sl-no-saved" style="color:#698996;font-size:0.95rem;">אין עדיין רשימות שמורות.</p>'
                : saved.map(function (list) {
                        return '<div class="sl-saved-list">' +
                            '<span>' + escapeHtml(list.name) + '</span>' +
                            '<div><button type="button" class="sl-btn sl-btn-secondary" data-load="' + escapeAttr(list.id) + '">טען לרשימה</button></div>' +
                            '</div>';
                    }).join('');
            slSavedLists.querySelectorAll('[data-load]').forEach(function (btn) {
                btn.addEventListener('click', function () {
                    var list = slSavedListsMap[btn.dataset.load];
                    if (list) window.ShoppingList.loadSavedListFromData(list);
                    render();
                });
            });
        }

        function escapeHtml(s) {
            var div = document.createElement('div');
            div.textContent = s;
            return div.innerHTML;
        }
        function escapeAttr(s) {
            return escapeHtml(s).replace(/"/g, '&quot;');
        }

        document.getElementById('slShareWhatsApp').addEventListener('click', function () {
            var url = window.ShoppingList.shareToWhatsApp();
            if (!url) {
                alert('הרשימה ריקה.');
                return;
            }
            window.open(url, '_blank');
        });

        document.getElementById('slSave').addEventListener('click', function () {
            var name = prompt('שם לרשימה:', 'רשימת קניות ' + new Date().toLocaleDateString('he-IL'));
            if (name === null) return;
            var agg = window.ShoppingList.getAggregated();
            if (agg.length === 0) {
                alert('הרשימה ריקה – אין מה לשמור.');
                return;
            }
            if (slIsLoggedIn && typeof window.slSaveToCloud === 'function') {
                window.slSaveToCloud(name, agg).then(function () {
                    alert('הרשימה נשמרה בחשבון שלך.');
                    if (typeof window.slRender === 'function') window.slRender();
                }).catch(function () {
                    alert('שגיאה בשמירה. נסי שוב.');
                });
            } else {
                var id = window.ShoppingList.saveNamedList(name);
                if (id) {
                    alert('הרשימה נשמרה בדפדפן.');
                    render();
                }
            }
        });

        document.getElementById('slClear').addEventListener('click', function () {
            if (!confirm('לנקות את כל הרשימה?')) return;
            window.ShoppingList.clear();
            render();
        });

        window.slRender = render;
        render();
    </script>
    <script>
        (function () {
            var auth = null;
            var db = null;
            var signInWithGoogle = null;
            var collection = null, doc = null, setDoc = null, getDocs = null, query = null, orderBy = null, serverTimestamp = null;

            function runRender() {
                if (typeof window.slRender === 'function') window.slRender();
            }

            function fetchSavedLists(uid) {
                if (!db || !uid) return Promise.resolve([]);
                var colRef = collection(db, 'users', uid, 'savedShoppingLists');
                var q = query(colRef, orderBy('createdAt', 'desc'));
                return getDocs(q).then(function (snap) {
                    return snap.docs.map(function (d) {
                        var data = d.data();
                        return {
                            id: d.id,
                            name: data.name || 'רשימת קניות',
                            items: Array.isArray(data.items) ? data.items : [],
                            createdAt: data.createdAt && data.createdAt.toMillis ? data.createdAt.toMillis() : 0
                        };
                    });
                }).catch(function () { return []; });
            }

            function initFirebase() {
                Promise.all([
                    import('./firebase.js'),
                    import('https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js')
                ]).then(function (imports) {
                    var fb = imports[0];
                    var firestore = imports[1];
                    auth = fb.auth;
                    db = fb.db;
                    signInWithGoogle = fb.signInWithGoogle;
                    collection = firestore.collection;
                    doc = firestore.doc;
                    setDoc = firestore.setDoc;
                    getDocs = firestore.getDocs;
                    query = firestore.query;
                    orderBy = firestore.orderBy;
                    serverTimestamp = firestore.serverTimestamp;

                    fb.onUserChange(function (user) {
                        slIsLoggedIn = !!user;
                        if (user) {
                            fetchSavedLists(user.uid).then(function (list) {
                                slSavedListsOverride = list;
                                runRender();
                            });
                        } else {
                            slSavedListsOverride = null;
                            runRender();
                        }
                    });

                    window.slSaveToCloud = function (name, items) {
                        var user = auth.currentUser;
                        if (!user || !db) return Promise.reject(new Error('לא מחוברת'));
                        var id = 'sl_' + Date.now();
                        var ref = doc(db, 'users', user.uid, 'savedShoppingLists', id);
                        return setDoc(ref, {
                            name: (name || 'רשימת קניות').trim() || 'רשימת קניות',
                            items: items,
                            createdAt: serverTimestamp()
                        }).then(function () {
                            return fetchSavedLists(user.uid).then(function (list) {
                                slSavedListsOverride = list;
                                runRender();
                            });
                        });
                    };

                    var btn = document.getElementById('slAuthBtn');
                    if (btn) btn.addEventListener('click', function () {
                        signInWithGoogle && signInWithGoogle();
                    });

                    if (auth.currentUser) {
                        slIsLoggedIn = true;
                        fetchSavedLists(auth.currentUser.uid).then(function (list) {
                            slSavedListsOverride = list;
                            runRender();
                        });
                    } else {
                        slSavedListsOverride = null;
                        slIsLoggedIn = false;
                        runRender();
                    }
                }).catch(function (err) {
                    console.warn('רשימת קניות: Firebase לא נטען', err);
                });
            }
            if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', initFirebase);
            else initFirebase();
        })();
    </script>
</body>
</html>
